name: Build Web Version

on:
  push:
    branches:
      - master
      - v1
    tags:
      - 'v*'
  pull_request:
  workflow_dispatch:
    inputs:
      commit_sha:
        description: 'Commit SHA to build (optional, defaults to current commit)'
        required: false

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-web:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.inputs.commit_sha || github.sha }}
      
      - name: Set up Emscripten
        uses: mymindstorm/setup-emsdk@v13
        with:
          version: latest
          # Disable caching to avoid conflicts when multiple jobs run simultaneously
          no-cache: true
      
      - name: Set up build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            git \
            libtbb-dev \
            jq \
            libgl1-mesa-dev \
            libx11-dev \
            libxrandr-dev \
            libxi-dev \
            libxcursor-dev \
            libxinerama-dev
      
      - name: Build Raylib for Web
        run: |
          source $EMSDK/emsdk_env.sh
          cd /tmp
          git clone --depth 1 --branch 5.0 https://github.com/raysan5/raylib.git raylib-src
          cd raylib-src
          mkdir build-web && cd build-web
          emcmake cmake .. \
            -DPLATFORM=Web \
            -DBUILD_SHARED_LIBS=OFF \
            -DBUILD_EXAMPLES=OFF \
            -DCMAKE_BUILD_TYPE=Release
          emmake make -j$(nproc)
          # Store the path for later use (build directory contains the library)
          echo "RAYLIB_WEB_DIR=$(pwd)" >> $GITHUB_ENV
          echo "RAYLIB_SRC_DIR=$(pwd)/.." >> $GITHUB_ENV
      
      - name: Initialize submodules
        run: make init
      
      - name: Build WebAssembly version
        run: |
          mkdir -p _/build-web
          cd _/build-web
          source $EMSDK/emsdk_env.sh
          emcmake cmake ../web \
            -DCMAKE_BUILD_TYPE=Release \
            -DRAYLIB_DIR=${{ env.RAYLIB_WEB_DIR }} \
            -DRAYLIB_SRC_DIR=${{ env.RAYLIB_SRC_DIR }}
          emmake make -j$(nproc) VERBOSE=1
      
      - name: Generate library manifest
        run: |
          chmod +x _/scripts/generate-library-manifest.sh
          _/scripts/generate-library-manifest.sh
          echo "✓ Library manifest generated"
      
      - name: Prepare web assets
        run: |
          mkdir -p web-dist
          cp _/build-web/dingcad_viewer.js web-dist/
          cp _/build-web/dingcad_viewer.wasm web-dist/
          cp _/build-web/dingcad_viewer.wasm.map web-dist/ || true
          cp _/web/index.html web-dist/
          cp _/web/simple.html web-dist/ || true
          cp scene.js web-dist/ || echo "// Default scene\nconst cube = cube({size: [10, 10, 10]});\nscene = cube;" > web-dist/scene.js
          
          # Copy library files and manifest
          if [ -d "_/library" ]; then
            cp -r _/library web-dist/library
            echo "✓ Copied library folder"
          else
            echo "⚠ Warning: _/library folder not found"
          fi
          
          if [ -f "_/config/library-manifest.json" ]; then
            cp _/config/library-manifest.json web-dist/library-manifest.json
            echo "✓ Copied library-manifest.json"
          else
            echo "⚠ Warning: library-manifest.json not found"
          fi
          
          # Create commit-specific version
          COMMIT_SHA=$(git rev-parse HEAD)
          COMMIT_SHORT=$(git rev-parse --short HEAD)
          mkdir -p web-dist/commits/${COMMIT_SHORT}
          
          # Copy files to commit-specific directory (before overwriting index.html)
          cp web-dist/*.{js,wasm} web-dist/commits/${COMMIT_SHORT}/ 2>/dev/null || true
          cp web-dist/index.html web-dist/commits/${COMMIT_SHORT}/ 2>/dev/null || true
          cp web-dist/simple.html web-dist/commits/${COMMIT_SHORT}/ 2>/dev/null || true
          cp web-dist/scene.js web-dist/commits/${COMMIT_SHORT}/ 2>/dev/null || true
          cp web-dist/library-manifest.json web-dist/commits/${COMMIT_SHORT}/ 2>/dev/null || true
          if [ -d "web-dist/library" ]; then
            cp -r web-dist/library web-dist/commits/${COMMIT_SHORT}/library 2>/dev/null || true
          fi
          
          # Create redirect index.html in root (after copying original to commit directory)
          cat > web-dist/index.html <<EOF
          <!DOCTYPE html>
          <html>
          <head>
            <title>DingCAD Web Viewer - Commit ${COMMIT_SHORT}</title>
            <meta http-equiv="refresh" content="0; url=./commits/${COMMIT_SHORT}/index.html?commit=${COMMIT_SHA}">
          </head>
          <body>
            <p>Redirecting to <a href="./commits/${COMMIT_SHORT}/index.html?commit=${COMMIT_SHA}">commit ${COMMIT_SHORT}</a>...</p>
          </body>
          </html>
          EOF
      
      - name: Upload web artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-build-${{ github.sha }}
          path: web-dist/
          retention-days: 30
      
      - name: Upload Pages artifact
        if: github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./web-dist

  deploy:
    if: github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/v')
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build-web
    steps:
      - name: Setup Pages
        uses: actions/configure-pages@v5
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

