name: PR Test Results

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  test-and-comment:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for commit info
      
      - name: Set up build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            git \
            libtbb-dev \
            libraylib-dev \
            jq
      
      - name: Initialize submodules
        run: make init
      
      - name: Build project
        run: make build
      
      - name: Run tests
        run: make test
        continue-on-error: true
      
      - name: Generate PR message
        id: pr_message
        run: |
          cd "$GITHUB_WORKSPACE"
          PR_MSG=$(./_/tests/scripts/generate_pr_message.sh)
          echo "pr_message<<EOF" >> $GITHUB_OUTPUT
          echo "$PR_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Comment PR with test results
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prMessage = `${{ steps.pr_message.outputs.pr_message }}`;
            
            // Find existing bot comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(
              comment => comment.user.type === 'Bot' && 
              comment.body.includes('ðŸ§ª Test Results')
            );
            
            const commentBody = `## ðŸ¤– Automated Test Results\n\n${prMessage}`;
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody,
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody,
              });
            }
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ github.sha }}
          path: |
            _/tests/results/latest/
            _/tests/results/README.md
          retention-days: 30

